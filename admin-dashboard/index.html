<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIM Marketplace - Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
    }

    .stat-card.pending .value { color: #f59e0b; }
    .stat-card.qualified .value { color: #10b981; }
    .stat-card.rejected .value { color: #ef4444; }
    .stat-card.badge .value { color: #8b5cf6; }

    .filters {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .applications-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
    }

    tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-qualified { background: #d1fae5; color: #065f46; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
    .status-needs_info { background: #dbeafe; color: #1e40af; }
    .status-badge_activated { background: #ede9fe; color: #5b21b6; }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-warning:hover { background: #d97706; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      font-size: 1.5rem;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .badge-level-selector {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
    }

    .badge-level-btn {
      flex: 1;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .badge-level-btn:hover {
      border-color: #667eea;
    }

    .badge-level-btn.active {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .badge-level-btn h4 {
      margin-bottom: 0.5rem;
      color: #333;
    }

    .badge-level-btn.level-1.active { border-color: #10b981; background: #ecfdf5; }
    .badge-level-btn.level-2.active { border-color: #8b5cf6; background: #f5f3ff; }
    .badge-level-btn.level-3.active { border-color: #f59e0b; background: #fffbeb; }
  </style>
</head>
<body>
  <div class="header">
    <h1>MIM Marketplace - Admin Dashboard</h1>
  </div>

  <div class="container">
    <!-- Statistics -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>Total Applications</h3>
        <div class="value" id="statTotal">-</div>
      </div>
      <div class="stat-card pending">
        <h3>Pending</h3>
        <div class="value" id="statPending">-</div>
      </div>
      <div class="stat-card qualified">
        <h3>Qualified</h3>
        <div class="value" id="statQualified">-</div>
      </div>
      <div class="stat-card rejected">
        <h3>Rejected</h3>
        <div class="value" id="statRejected">-</div>
      </div>
      <div class="stat-card badge">
        <h3>Badge Activated</h3>
        <div class="value" id="statBadge">-</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <button class="filter-btn active" data-status="">All</button>
      <button class="filter-btn" data-status="pending">Pending</button>
      <button class="filter-btn" data-status="needs_info">Needs Info</button>
      <button class="filter-btn" data-status="qualified">Qualified</button>
      <button class="filter-btn" data-status="rejected">Rejected</button>
      <button class="filter-btn" data-status="badge_activated">Badge Activated</button>
    </div>

    <!-- Applications Table -->
    <div class="applications-table">
      <div id="loading" class="loading">Loading applications...</div>
      <table id="applicationsTable" style="display: none;">
        <thead>
          <tr>
            <th>Seller Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>City</th>
            <th>Shop URL</th>
            <th>Selling Duration</th>
            <th>Badge Use</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applicationsBody">
        </tbody>
      </table>
      <div id="emptyState" class="empty-state" style="display: none;">
        No applications found
      </div>
    </div>
  </div>

  <!-- Application Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Application Details</h2>
        <button class="close-btn" onclick="closeModal('detailModal')">&times;</button>
      </div>
      <div id="applicationDetails"></div>
    </div>
  </div>

  <!-- Status Update Modal -->
  <div class="modal" id="statusModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Update Status</h2>
        <button class="close-btn" onclick="closeModal('statusModal')">&times;</button>
      </div>
      <form id="statusForm">
        <input type="hidden" id="statusApplicationId">
        <div class="form-group">
          <label>Status</label>
          <select id="statusSelect" required>
            <option value="pending">Pending</option>
            <option value="needs_info">Needs Info</option>
            <option value="qualified">Qualified</option>
            <option value="rejected">Rejected</option>
            <option value="badge_activated">Badge Activated</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="statusNotes" placeholder="Add notes about this status change..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Update Status</button>
      </form>
    </div>
  </div>

  <!-- Badge Creation Modal -->
  <div class="modal" id="badgeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create Verification Badge</h2>
        <button class="close-btn" onclick="closeModal('badgeModal')">&times;</button>
      </div>
      <form id="badgeForm">
        <input type="hidden" id="badgeApplicationId">
        <div class="form-group">
          <label>Select Badge Level</label>
          <div class="badge-level-selector">
            <div class="badge-level-btn level-1 active" data-level="1" onclick="selectBadgeLevel(1)">
              <h4>Level 1</h4>
              <p>Verified Seller</p>
            </div>
            <div class="badge-level-btn level-2" data-level="2" onclick="selectBadgeLevel(2)">
              <h4>Level 2</h4>
              <p>Trusted Seller</p>
            </div>
            <div class="badge-level-btn level-3" data-level="3" onclick="selectBadgeLevel(3)">
              <h4>Level 3</h4>
              <p>Golden Seller</p>
            </div>
          </div>
          <input type="hidden" id="badgeLevel" value="1">
        </div>
        <button type="submit" class="btn btn-success">Create & Activate Badge</button>
      </form>
    </div>
  </div>

  <script>
    // Use Render URL if available, otherwise use current origin
    const API_URL = window.location.origin.includes('render.com') 
      ? window.location.origin 
      : (window.location.origin.includes('localhost') 
          ? 'http://localhost:3000' 
          : 'https://mimmarketplace.onrender.com');
    let currentStatusFilter = '';
    let selectedBadgeLevel = 1;

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadApplications();
      setupEventListeners();
      
      // Auto-refresh every 30 seconds to show new applications
      setInterval(() => {
        loadStats();
        loadApplications();
      }, 30000);
    });

    function setupEventListeners() {
      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentStatusFilter = btn.dataset.status;
          loadApplications();
        });
      });

      // Status form
      document.getElementById('statusForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('statusApplicationId').value;
        const status = document.getElementById('statusSelect').value;
        const notes = document.getElementById('statusNotes').value;
        await updateStatus(id, status, notes);
      });

      // Badge form
      document.getElementById('badgeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('badgeApplicationId').value;
        const level = parseInt(document.getElementById('badgeLevel').value);
        await createBadge(id, level);
      });
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/applications/stats`);
        const stats = await response.json();
        
        document.getElementById('statTotal').textContent = stats.total;
        document.getElementById('statPending').textContent = stats.pending;
        document.getElementById('statQualified').textContent = stats.qualified;
        document.getElementById('statRejected').textContent = stats.rejected;
        document.getElementById('statBadge').textContent = stats.badgeActivated;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    async function loadApplications() {
      const loading = document.getElementById('loading');
      const table = document.getElementById('applicationsTable');
      const emptyState = document.getElementById('emptyState');
      const tbody = document.getElementById('applicationsBody');

      loading.style.display = 'block';
      table.style.display = 'none';
      emptyState.style.display = 'none';

      try {
        const url = currentStatusFilter 
          ? `${API_URL}/applications?status=${currentStatusFilter}`
          : `${API_URL}/applications`;
        
        const response = await fetch(url);
        const applications = await response.json();

        loading.style.display = 'none';

        if (applications.length === 0) {
          emptyState.style.display = 'block';
          return;
        }

        tbody.innerHTML = applications.map(app => {
          const submittedFields = app.submitted_fields || {};
          const shopUrl = app.selling_page || submittedFields.mainSalesPageLink || submittedFields.sellingPage;
          const badgeUse = Array.isArray(app.badge_use) 
            ? app.badge_use.join(', ')
            : (app.badge_use || submittedFields.preferredBadgeUse || (Array.isArray(submittedFields.badgeUsageLocations) 
              ? submittedFields.badgeUsageLocations.join(', ')
              : submittedFields.badgeUsageLocations || '-'));

          return `
          <tr>
            <td><strong>${app.seller_name}</strong></td>
            <td>${app.email}</td>
            <td>${app.phone || '-'}</td>
            <td>${app.city || submittedFields.city || '-'}</td>
            <td>
              ${shopUrl 
                ? `<a href="${shopUrl}" target="_blank" style="color:#667eea;">Visit</a>` 
                : '-'}
            </td>
            <td>${app.time_selling || submittedFields.sellingDuration || submittedFields.timeSelling || '-'}</td>
            <td>${badgeUse}</td>
            <td>${app.category}</td>
            <td><span class="status-badge status-${app.status}">${app.status.replace('_', ' ')}</span></td>
            <td>${new Date(app.created_at).toLocaleDateString()}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-primary" onclick="viewDetails('${app.id}')">View</button>
                <button class="btn btn-warning" onclick="openStatusModal('${app.id}', '${app.status}')">Status</button>
                ${app.status === 'qualified' ? `<button class="btn btn-success" onclick="openBadgeModal('${app.id}')">Create Badge</button>` : ''}
              </div>
            </td>
          </tr>
        `;
        }).join('');

        table.style.display = 'table';
      } catch (error) {
        console.error('Error loading applications:', error);
        loading.textContent = 'Error loading applications';
      }
    }

    async function viewDetails(id) {
      try {
        const response = await fetch(`${API_URL}/applications/${id}`);
        const app = await response.json();
        
        const submittedFields = app.submitted_fields || {};
        const details = `
          <div class="form-group">
            <label>Seller Name</label>
            <input type="text" value="${app.seller_name}" readonly>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" value="${app.email}" readonly>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="text" value="${app.phone || '-'}" readonly>
          </div>
          <div class="form-group">
            <label>Category</label>
            <input type="text" value="${app.category}" readonly>
          </div>
          <div class="form-group">
            <label>Language</label>
            <input type="text" value="${app.language}" readonly>
          </div>
          <div class="form-group">
            <label>Status</label>
            <input type="text" value="${app.status}" readonly>
          </div>
          ${app.city || submittedFields.city ? `
          <div class="form-group">
            <label>City</label>
            <input type="text" value="${app.city || submittedFields.city}" readonly>
          </div>
          ` : ''}
          ${app.products_category ? `
          <div class="form-group">
            <label>Products Category</label>
            <input type="text" value="${app.products_category}" readonly>
          </div>
          ` : ''}
          ${app.selling_page ? `
          <div class="form-group">
            <label>Main Shop URL</label>
            <a href="${app.selling_page}" target="_blank" style="color: #667eea;">${app.selling_page}</a>
          </div>
          ` : ''}
          ${app.secondary_selling_page ? `
          <div class="form-group">
            <label>Secondary Shop URL</label>
            <a href="${app.secondary_selling_page}" target="_blank" style="color: #667eea;">${app.secondary_selling_page}</a>
          </div>
          ` : ''}
          ${app.time_selling ? `
          <div class="form-group">
            <label>Time Selling</label>
            <input type="text" value="${app.time_selling}" readonly>
          </div>
          ` : ''}
          ${app.feedbacks ? `
          <div class="form-group">
            <label>Feedbacks</label>
            <input type="text" value="${app.feedbacks}" readonly>
          </div>
          ` : ''}
          ${app.return_policies ? `
          <div class="form-group">
            <label>Return Policies</label>
            <textarea readonly>${app.return_policies}</textarea>
          </div>
          ` : ''}
          ${app.fake_orders ? `
          <div class="form-group">
            <label>Fake Orders</label>
            <input type="text" value="${app.fake_orders}" readonly>
          </div>
          ` : ''}
          ${app.delivery_duration ? `
          <div class="form-group">
            <label>Delivery Duration</label>
            <input type="text" value="${app.delivery_duration}" readonly>
          </div>
          ` : ''}
          ${app.delivery_zone ? `
          <div class="form-group">
            <label>Delivery Zone</label>
            <input type="text" value="${app.delivery_zone}" readonly>
          </div>
          ` : ''}
          ${app.badge_use && app.badge_use.length > 0 ? `
          <div class="form-group">
            <label>Badge Use</label>
            <input type="text" value="${Array.isArray(app.badge_use) ? app.badge_use.join(', ') : app.badge_use}" readonly>
          </div>
          ` : ''}
          ${app.products_type ? `
          <div class="form-group">
            <label>Products Type</label>
            <input type="text" value="${app.products_type}" readonly>
          </div>
          ` : ''}
          ${app.other_products ? `
          <div class="form-group">
            <label>Other Products</label>
            <textarea readonly>${app.other_products}</textarea>
          </div>
          ` : ''}
          ${app.valid_product !== null && app.valid_product !== undefined ? `
          <div class="form-group">
            <label>Valid Product</label>
            <input type="text" value="${app.valid_product ? 'Yes' : 'No'}" readonly>
          </div>
          ` : ''}
          ${submittedFields.secondarySalesPageLink ? `
          <div class="form-group">
            <label>Secondary Shop URL</label>
            <a href="${submittedFields.secondarySalesPageLink}" target="_blank" style="color: #667eea;">${submittedFields.secondarySalesPageLink}</a>
          </div>
          ` : ''}
          ${submittedFields.mainSalesPageLink ? `
          <div class="form-group">
            <label>Shop URL</label>
            <a href="${submittedFields.mainSalesPageLink}" target="_blank" style="color: #667eea;">${submittedFields.mainSalesPageLink}</a>
          </div>
          ` : ''}
          ${submittedFields.productsAndBrand ? `
          <div class="form-group">
            <label>Products & Brand</label>
            <textarea readonly>${submittedFields.productsAndBrand}</textarea>
          </div>
          ` : ''}
          ${submittedFields.salesCategories && submittedFields.salesCategories.length > 0 ? `
          <div class="form-group">
            <label>Sales Categories</label>
            <input type="text" value="${Array.isArray(submittedFields.salesCategories) ? submittedFields.salesCategories.join(', ') : submittedFields.salesCategories}" readonly>
          </div>
          ` : ''}
          ${submittedFields.otherProducts ? `
          <div class="form-group">
            <label>Other Products</label>
            <textarea readonly>${submittedFields.otherProducts}</textarea>
          </div>
          ` : ''}
          ${submittedFields.productType ? `
          <div class="form-group">
            <label>Product Type</label>
            <input type="text" value="${submittedFields.productType}" readonly>
          </div>
          ` : ''}
          ${submittedFields.sellingDuration ? `
          <div class="form-group">
            <label>Selling Duration</label>
            <input type="text" value="${submittedFields.sellingDuration}" readonly>
          </div>
          ` : ''}
          ${submittedFields.shippingTime ? `
          <div class="form-group">
            <label>Shipping Time</label>
            <input type="text" value="${submittedFields.shippingTime}" readonly>
          </div>
          ` : ''}
          ${submittedFields.deliveryArea ? `
          <div class="form-group">
            <label>Delivery Area</label>
            <input type="text" value="${submittedFields.deliveryArea}" readonly>
          </div>
          ` : ''}
          ${submittedFields.preferredBadgeUse ? `
          <div class="form-group">
            <label>Preferred Badge Use</label>
            <input type="text" value="${submittedFields.preferredBadgeUse}" readonly>
          </div>
          ` : ''}
          ${submittedFields.customerFeedback ? `
          <div class="form-group">
            <label>Customer Feedback</label>
            <input type="text" value="${submittedFields.customerFeedback}" readonly>
          </div>
          ` : ''}
          ${submittedFields.returnHandling ? `
          <div class="form-group">
            <label>Return Handling</label>
            <textarea readonly>${submittedFields.returnHandling}</textarea>
          </div>
          ` : ''}
          ${submittedFields.fakeOrdersExperience ? `
          <div class="form-group">
            <label>Fake Orders Experience</label>
            <input type="text" value="${submittedFields.fakeOrdersExperience}" readonly>
          </div>
          ` : ''}
          ${submittedFields.imagesBelongToStore !== undefined ? `
          <div class="form-group">
            <label>Images Belong to Store</label>
            <input type="text" value="${submittedFields.imagesBelongToStore ? 'Yes' : 'No'}" readonly>
          </div>
          ` : ''}
          ${submittedFields.badgeUsageLocations && submittedFields.badgeUsageLocations.length > 0 ? `
          <div class="form-group">
            <label>Badge Usage Locations</label>
            <input type="text" value="${Array.isArray(submittedFields.badgeUsageLocations) ? submittedFields.badgeUsageLocations.join(', ') : submittedFields.badgeUsageLocations}" readonly>
          </div>
          ` : ''}
          ${submittedFields.whatsappNumber ? `
          <div class="form-group">
            <label>WhatsApp</label>
            <input type="text" value="${submittedFields.whatsappNumber}" readonly>
          </div>
          ` : ''}
          ${submittedFields.instagramHandle ? `
          <div class="form-group">
            <label>Instagram</label>
            <a href="${submittedFields.instagramHandle}" target="_blank" style="color:#667eea;">${submittedFields.instagramHandle}</a>
          </div>
          ` : ''}
          ${submittedFields.facebookHandle ? `
          <div class="form-group">
            <label>Facebook</label>
            <a href="${submittedFields.facebookHandle}" target="_blank" style="color:#667eea;">${submittedFields.facebookHandle}</a>
          </div>
          ` : ''}
          ${submittedFields.tiktokHandle ? `
          <div class="form-group">
            <label>TikTok</label>
            <a href="${submittedFields.tiktokHandle}" target="_blank" style="color:#667eea;">${submittedFields.tiktokHandle}</a>
          </div>
          ` : ''}
          ${submittedFields.additionalNotes ? `
          <div class="form-group">
            <label>Additional Notes</label>
            <textarea readonly>${submittedFields.additionalNotes}</textarea>
          </div>
          ` : ''}
          ${submittedFields.adminNotes ? `
          <div class="form-group">
            <label>Admin Notes</label>
            <textarea readonly style="background: #f9fafb;">${submittedFields.adminNotes}</textarea>
          </div>
          ` : ''}
          <div class="form-group">
            <label>Created At</label>
            <input type="text" value="${new Date(app.created_at).toLocaleString()}" readonly>
          </div>
          <div class="form-group">
            <label>Updated At</label>
            <input type="text" value="${new Date(app.updated_at).toLocaleString()}" readonly>
          </div>
        `;
        
        document.getElementById('applicationDetails').innerHTML = details;
        openModal('detailModal');
      } catch (error) {
        console.error('Error loading details:', error);
        alert('Error loading application details');
      }
    }

    function openStatusModal(id, currentStatus) {
      document.getElementById('statusApplicationId').value = id;
      document.getElementById('statusSelect').value = currentStatus;
      document.getElementById('statusNotes').value = '';
      openModal('statusModal');
    }

    function openBadgeModal(id) {
      document.getElementById('badgeApplicationId').value = id;
      selectedBadgeLevel = 1;
      selectBadgeLevel(1);
      openModal('badgeModal');
    }

    function selectBadgeLevel(level) {
      selectedBadgeLevel = level;
      document.getElementById('badgeLevel').value = level;
      document.querySelectorAll('.badge-level-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.dataset.level) === level) {
          btn.classList.add('active');
        }
      });
    }

    async function updateStatus(id, status, notes) {
      try {
        const response = await fetch(`${API_URL}/applications/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, notes }),
        });

        if (response.ok) {
          closeModal('statusModal');
          loadStats();
          loadApplications();
          alert('Status updated successfully!');
        } else {
          const error = await response.json();
          alert('Error: ' + (error.message || 'Failed to update status'));
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status');
      }
    }

    async function createBadge(id, level) {
      try {
        const response = await fetch(`${API_URL}/badges/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ applicationId: id, level }),
        });

        if (response.ok) {
          const badge = await response.json();
          closeModal('badgeModal');
          loadStats();
          loadApplications();
          alert(`Badge created successfully!\nBadge Code: ${badge.code}\nBadge URL: ${badge.badgeUrl}`);
        } else {
          const error = await response.json();
          alert('Error: ' + (error.message || 'Failed to create badge'));
        }
      } catch (error) {
        console.error('Error creating badge:', error);
        alert('Error creating badge');
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Close modal on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>

